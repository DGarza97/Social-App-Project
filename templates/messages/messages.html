{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Messages | Social App</title>
    <link rel="stylesheet" href="{% static 'css/messages.css' %}">
</head>

<body>

    <!-- PROFILE DROPDOWN -->
    <div class="profile-wrapper">
        <img class="profile-icon"
            src="https://ui-avatars.com/api/?name={{ request.user.username }}&background=111827&color=ffffff"
            alt="Profile picture" id="profileToggle" />
        <div class="profile-dropdown" id="profileDropdown">
            <a href="{% url 'profile' %}">Profile</a>
            <a href="#">Settings</a>
            <form method="post" action="{% url 'logout' %}" class="logout-form">
                {% csrf_token %}
                <button type="submit" class="logout-btn">Sign Out</button>
            </form>
        </div>
    </div>

    <!-- SIDEBAR -->
    <div class="sidebar">
        <a href="{% url 'feed' %}">Home</a>
        <a href="{% url 'my_projects' %}">My Projects</a>
        <a href="{% url 'groups' %}">Groups</a>
        <a href="{% url 'messages' %}" class="active">Messages</a>
    </div>

    <!-- MESSAGES LAYOUT -->
    <div class="messages-page">

        <!-- CONVERSATIONS -->
        <div class="conversations">
            <h2>Messages</h2>

            {% for conversation in conversations %}
            <a href="{% url 'messages' conversation.id %}"
                class="conversation {% if active_conversation and conversation.id == active_conversation.id %}active{% endif %}">
                <strong>
                    {{ conversation.other_user.username }}
                </strong>
                <p class="preview">
                    {{ conversation.last_message|default:"No messages yet" }}
                </p>
            </a>
            {% empty %}
            <p class="empty-state">No conversations yet.</p>
            {% endfor %}
        </div>

        <!-- CHAT -->
        <div class="chat">

            {% if active_conversation %}
            <div class="chat-header">
                <h3>
                    {{ active_conversation.other_user.username }}
                </h3>
            </div>

            <div class="chat-messages">
                {% for message in messages %}
                <div class="message {% if message.sender == request.user %}me{% else %}them{% endif %}">
                    {{ message.content }}
                </div>
                {% empty %}
                <p class="empty-state">No messages yet.</p>
                {% endfor %}
            </div>

            <form method="post" class="chat-input">
                {% csrf_token %}
                <textarea name="content" placeholder="Type a messageâ€¦" required></textarea>
                <button type="submit">Send</button>
            </form>

            {% else %}
            <div class="chat-empty">
                <p>Select a conversation to start messaging.</p>
            </div>
            {% endif %}

        </div>
    </div>

    <!-- AUTO-SCROLL -->
    <script>
        const chatMessages = document.querySelector(".chat-messages");
        if (chatMessages) {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    </script>

    <!-- PROFILE JS -->
    <script>
        const profileToggle = document.getElementById("profileToggle");
        const profileDropdown = document.getElementById("profileDropdown");

        profileToggle.addEventListener("click", function (e) {
            e.stopPropagation();
            profileDropdown.classList.toggle("show");
        });

        document.addEventListener("click", function () {
            profileDropdown.classList.remove("show");
        });
    </script>

</body>

</html>
